<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Nostr Social Profile</title>
    <script type="application/ld+json" id="data">
      {
        "@id": ""
      }
    </script>
    <script type="module">
      import { html, render } from '../js/standalone.module.js'
      import '../js/nostr-ui.js'
      import Event from '../lib/index.js'

      function doc() {
        if (di.data.length) {
          return di.data[0]
        } else {
          return di.data
        }
      }

      async function getJsonFromUrl(url) {
        try {
          const response = await fetch(url)

          // check if the HTTP response status is successful
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`)
          }

          const data = await response.json()
          return data
        } catch (error) {
          console.error('Error:', error)
          return null
        }
      }

      function stripHTMLKeepLinksAndImages(html) {
        let doc = new DOMParser().parseFromString(html, 'text/html')
        let result = ''

        for (let node of doc.body.childNodes) {
          if (node.nodeName.toLowerCase() === 'img') {
            result += node.src + '\n'
          } else if (node.nodeName.toLowerCase() === 'a') {
            result += node.href + '\n'
          } else {
            result += node.textContent || node.innerText || ''
          }
        }

        return result
      }

      const docEvent = doc().mainEntity

      const event = qs.event || docEvent

      console.log(event)
      if (qs.event) {
        let uri = 'https://mostr.pub/objects/' + qs.event
        getJsonFromUrl(uri).then(data => {
          console.log(data)
          data.content = stripHTMLKeepLinksAndImages(data.content)
          data.pubkey = data.attributedTo?.split('/users/')[1]
          let event = {
            '@context': 'https://w3id.org/nostr/context',
            '@id': data.id,
            '@type': 'Event',
            content: data.content,
            created_at: data.created_at,
            id: data.id,
            kind: data.kind || 1,
            tags: [[]],
            pubkey: data.pubkey,
            sig: data.sig,
            tags: data.tags
          }
          render(html` <${Event} event=${event} /> `, document.body)
        })
      } else {
        render(html` <${Event} event=${event} /> `, document.body)
      }
    </script>
  </head>
  <body></body>
</html>
